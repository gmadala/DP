<section class="row-fluid">
  <section class="span9">
    <div ng-switch="paymentQueue.contents.isEmpty()">

      <!-- When there are no payments or fees -->
      <div class="info-block" ng-switch-when="true">
        <div class="info-block-image">
          <span nxg-icon="icon-info"></span>
        </div>
        <p class="info-block-text">
          You have no payments selected for checkout. Please visit the
          <a href="#/home/payments">Payments list</a> to select some.
        </p>
      </div>

      <!-- When you have payments or fees in your cart -->
      <section ng-switch-when="false">
        <!-- Fees List -->
        <div class="well" ng-show="paymentQueue.sum.feeCount() > 0">
          <h2 class="well-title">Account Fees</h2>
          <table class="table table-striped table-primary">
            <thead>
              <th>Due Date</th>
              <th>Fee Type</th>
              <th>Payment Date</th>
              <th>Fee Amount</th>
            </thead>

            <tr class="separated" ng-repeat="fee in paymentQueue.contents.fees">
              <td class="paired paired-reversed">
                 <span class="paired-media svg-icon" ng-class="paymentQueue.getDueStatus(fee)" ng-switch="paymentQueue.getDueStatus(fee)">
                  <span ng-switch-when="today" nxg-icon="icon-warning"></span>
                  <span ng-switch-when="overdue" nxg-icon="icon-alert"></span>
                </span>
                <div class="paired-body">
                  <p class="lockup-major" ng-class="{ 'color-danger': paymentQueue.getDueStatus(fee) == 'overdue' }">{{ fee.dueDate | moment }}</p>
                </div>
              </td>
              <td>
                <p class="lockup-major">{{ fee.type || 'N/A' }}</p>
              </td>
              <td>
                <!-- cannot schedule (overdue or due today), and WITHIN business hours -->
                <h4 class="lockup-major" ng-show="canPayNow && !paymentQueue.canSchedule(fee)">
                  <span class="sub-label">Today: </span>{{ todayDate | moment }}
                </h4>

                <!-- cannot schedule (overdue or due today), and OUTSIDE business hours -->
                <h4 class="lockup-major" ng-show="!canPayNow && !paymentQueue.canSchedule(fee)">
                  <span class="sub-label">Future: </span>{{ fee.scheduleDate | moment }}
                </h4>

                <!-- can schedule, and hasn't been scheduled yet (within business hours) -->
                <h4 class="lockup-major" ng-show="canPayNow && paymentQueue.canSchedule(fee) && !fee.scheduleDate">
                  <span class="sub-label">Today: </span>{{ todayDate | moment }}
                </h4>

                <!-- can schedule, and hasn't been scheduled yet (outside business hours; should have already been set to have a scheduled date.) -->
                <h4 class="lockup-major" ng-show="!canPayNow && paymentQueue.canSchedule(fee)">
                  <span class="sub-label">Future: </span>{{ fee.scheduleDate | moment }}
                </h4>

                <p class="lockup-minor" ng-show="!paymentQueue.canSchedule(fee) && canPayNow">
                  Unable to Schedule
                  <button class="btn-help"
                      tooltip-placement="right"
                      tooltip="Payments are unable to be scheduled for loans that are overdue or due today."
                      tooltip-popup-delay=300>
                    <span nxg-icon="icon-help"></span>
                  </button>
                </p>
                <button class="btn-unstyle btn-link"
                        ng-click="paymentQueue.schedule(fee)"
                        ng-show="paymentQueue.canSchedule(fee)"
                        ng-disabled="fee.scheduleLoading || submitInProgress">
                  Change Payment Date
                </button>
              </td>
              <td class="numeric">
                <p class="lockup-major">{{ fee.amount | currency }}</p>
                <button class="btn-unstyle btn-link right" ng-click="paymentQueue.removeFee(fee.financialRecordId)" ng-disabled="submitInProgress">Remove</button>
              </td>
            </tr>
          </table>
        </div>

        <!-- Payments List -->
        <div class="well" ng-show="paymentQueue.sum.paymentCount() > 0">
          <h2 class="well-title">Vehicle Payments</h2>

          <table class="table table-striped table-primary">
            <thead>
              <th>Due Date</th>
              <th>Description</th>
              <th>Payment Date</th>
              <th>Payment Amount</th>
            </thead>

            <tr class="separated" ng-repeat="payment in paymentQueue.contents.payments">
              <td class="paired paired-reversed">
                <span class="paired-media svg-icon" ng-class="paymentQueue.getDueStatus(payment)" ng-switch="paymentQueue.getDueStatus(payment)">
                  <span ng-switch-when="today" nxg-icon="icon-warning"></span>
                  <span ng-switch-when="overdue" nxg-icon="icon-alert"></span>
                </span>
                <div class="paired-body">
                  <p class="lockup-major" ng-class="{ 'color-danger': paymentQueue.getDueStatus(payment) == 'overdue' }">{{ payment.dueDate | moment }}</p>
                </div>
              </td>
              <td>
                <a class="lockup-major " href="#/vehicledetails?stockNumber={{ payment.stockNum }}">{{ payment.description }}</a>
                <p class="lockup-minor caps vin">VIN: {{ payment.vin }}</p>
                <p class="lockup-minor caps stock">STK: {{ payment.stockNum }}</p>

                <div nxg-alternate-address="payment" enabled="payment.isPayoff" show-tooltip="true" ng-disabled="submitInProgress"></div>
              </td>
              <td>
                <!-- cannot schedule (overdue or due today), and WITHIN business hours -->
                <h4 class="lockup-major" ng-show="canPayNow && !paymentQueue.canSchedule(payment)">
                  <span class="sub-label">Today: </span>{{ todayDate | moment }}
                </h4>

                <!-- cannot schedule (overdue or due today), and OUTSIDE business hours -->
                <h4 class="lockup-major" ng-show="!canPayNow && !paymentQueue.canSchedule(payment)">
                  <span class="sub-label">Future: </span>{{ payment.scheduleDate | moment }}
                </h4>

                <!-- can schedule, and hasn't been scheduled yet (within business hours) -->
                <h4 class="lockup-major" ng-show="canPayNow && paymentQueue.canSchedule(payment) && !payment.scheduleDate">
                  <span class="sub-label">Today: </span>{{ todayDate | moment }}
                </h4>

                <!-- can schedule, and hasn't been scheduled yet (outside business hours; should have already been set to have a scheduled date.) -->
                <h4 class="lockup-major" ng-show="!canPayNow && paymentQueue.canSchedule(payment)">
                  <span class="sub-label">Future: </span>{{ payment.scheduleDate | moment }}
                </h4>

                <p class="lockup-minor" ng-show="!paymentQueue.canSchedule(payment) && canPayNow">
                  Unable to Schedule
                  <button class="btn-help inline"
                      tooltip-placement="right"
                      tooltip-trigger="hover"
                      tooltip="Payments are unable to be scheduled for loans that are overdue or due today."
                      tooltip-animation="true"><span nxg-icon="icon-help"></span></button>
                </p>

                <button class="btn-unstyle btn-link"
                        ng-click="paymentQueue.schedule(payment)"
                        ng-show="paymentQueue.canSchedule(payment) && !canPayNow"
                        ng-disabled="payment.scheduleLoading || submitInProgress">
                  Change Payment Date
                </button>
              </td>
              <td class="numeric split">
                <div class="split-cell">
                  <p class="lockup-major">{{ payment.amount | currency }}</p>
                  <button class="btn-unstyle btn-link right"
                          ng-click="paymentQueue.removePayment(payment.floorplanId)"
                          ng-disabled="submitInProgress"
                          nxg-track="{{metric.CLICK_CHECKOUT_REMOVE_PAYMENT_LINK}}">
                    Remove
                  </button>
                </div>
                <div class="split-cell">
                  <ul class="list-table mini">
                    <li class="list-table-row">
                      <p class="span6">Principal:</p><p class="span6 numeric">{{payment.principal | currency}}</p>
                    </li>
                    <li class="list-table-row">
                      <p class="span6">Interest:</p><p class="span6 numeric">{{payment.interestTotal | currency}}</p>
                    </li>
                    <li class="list-table-row">
                      <p class="span6">Fee(s):</p><p class="span6 numeric">{{payment.feesTotal | currency}}</p>
                    </li>
                    <li class="list-table-row" ng-show="payment.collateralTotal > 0">
                      <p class="span6">CPP:</p><p class="span6 numeric">{{payment.collateralTotal | currency}}</p>
                    </li>
                  </ul>
                </div>
                <!-- <label class="text-error" ng-show="!!payment.scheduleError">{{ payment.scheduleError }}</label> -->
              </td>
            </tr>
          </table>
        </div>
      </section>
    </div>
  </section>

  <form class="span3 well sticky" name="paymentForm" novalidate nxg-sticky>
    <h2 class="well-title">Payment Summary</h2>
      <section class="well-item well-dark">
        <p>Please review the following and submit your payments below.</p>
        <button type="button"
                class="btn-cta cta-secondary btn-center"
                ng-click="exportPaymentSummary()"
                ng-disabled="paymentQueue.sum.todayCount() == 0"
                nxg-track="{{metric.CLICK_CHECKOUT_EXPORT_PAYMENTS_SUMMARY_BUTTON}}">
          Export Summary <span nxg-icon="icon-document" class="icon-small"></span>
        </button>
      </section>

      <section class="well-item well-light bordered">
        <!-- Payments -->
        <div class="alt-lockup">
          <h2 class="subtitle">{{ paymentQueue.sum.todayCount() }}
            <span ng-show="paymentQueue.sum.todayCount() == 1">Payment</span>
            <span ng-hide="paymentQueue.sum.todayCount() == 1">Payments</span>
            Today
          </h2>

          <p class="lockup-minor">In the Amount of</p>
          <h3 class="lockup-major" ng-bind="paymentQueue.sum.todayTotal() | currency"></h3>
        </div>

        <!-- If User has Unapplied Funds -->
        <!-- We add an inline style (display: none) here to avoid the flash
        of our ng-show content before the page finishes compiling and knows
        the ng-show expression should evaluate to false. -->
        <div ng-show="unappliedFunds.available > 0">
          <div class="alt-lockup">
            <p class="lockup-minor">Available Unapplied Funds</p>
            <h3 class="lockup-major" ng-bind="unappliedFunds.available | currency"></h3>
          </div>

          <div class="alt-lockup">
            <p class="lockup-minor">Apply these Funds to Payment?</p>
            <div class="cr-inline float-r">
              <input type="radio" name="useUnapplied" id="unappliedYes" placeholder="Yes"
                     ng-value="true" ng-model="unappliedFunds.useFunds"
                     nxg-track="{{metric.CLICK_CHECKOUT_APPLY_FUNDS_YES}}"
                     ng-disabled="paymentQueue.sum.todayTotal() == 0 || submitInProgress">
              <label class="radio-img" for="unappliedYes"></label>
              <label class="cr-label" for="unappliedYes">Yes</label>

              <input type="radio" name="useUnapplied" id="unappliedNo" placeholder="No"
                     ng-value="false" ng-model="unappliedFunds.useFunds"
                     ng-disabled="paymentQueue.sum.todayTotal() == 0 || submitInProgress">
              <label class="radio-img" for="unappliedNo"></label>
              <label class="cr-label" for="unappliedNo">No</label>
            </div>
          </div>

          <div class="alt-lockup align-right" ng-show="unappliedFunds.useFunds">
            <label class="lockup-minor" for="unappliedAmt">Unapplied Funds to Use</label>
            <span class="input-prepend dollar">
              <span class="add-on">$</span>
              <input id="unappliedAmt" name="unappliedAmt"
                     class="input-small"
                     type="text"
                     placeholder="0.00"
                     ng-model="unappliedFunds.useAmount"
                     nxg-min="unappliedFunds.min()"
                     nxg-max="unappliedFunds.max()"
                     ng-pattern="/^[0-9]{1,3}(?:,?[0-9]{3})*(\.[0-9]{2})?$/"
                     ng-required="unappliedFunds.useFunds"
                     ng-disabled="submitInProgress"
                     ng-class="{ 'nxg-invalid': validity.unappliedAmt.$error.required || validity.unappliedAmt.$error.pattern || validity.unappliedAmt.$error.nxgMin || validity.unappliedAmt.$error.nxgMax }" />
            </span>
            <label class="text-error" ng-show="validity.unappliedAmt.$error.required">
              Please enter the amount of unapplied funds to use.
            </label>
            <label class="text-error" ng-show="validity.unappliedAmt.$error.pattern">
              Please enter the amount of unapplied funds as a number with no more than 2 decimals.
            </label>
            <label class="text-error" ng-show="validity.unappliedAmt.$error.nxgMin || validity.unappliedAmt.$error.nxgMax">
                Unapplied funds must be <span ng-bind="unappliedFunds.min() | currency"></span> to <span ng-bind="unappliedFunds.max() | currency"></span>
            </label>
          </div>

          <div class="alt-lockup" ng-show="unappliedFunds.useFunds">
            <p class="lockup-minor">Remaining Payment Balance</p>
            <h3 class="lockup-major" ng-bind="paymentQueue.sum.todayTotal() - unappliedFunds.useAmount | currency"></h3>
          </div>
        </div>
      </section>

      <section class="well-item well-light bordered">
        <div class="alt-lockup">
          <h2 class="subtitle">{{ paymentQueue.sum.scheduledCount() }} Future
            <span ng-show="paymentQueue.sum.scheduledCount() == 1">Payment</span>
            <span ng-hide="paymentQueue.sum.scheduledCount() == 1">Payments</span>
          </h2>
          <p class="lockup-minor">In the Amount of</p>
          <h3 class="lockup-major" ng-bind="paymentQueue.sum.scheduledTotal() | currency"></h3>
        </div>
      </section>

      <section class="well-item well-dark bordered">
        <!-- Bank Account -->
        <label for="bankAccount">Bank Account</label>
        <div class="style-select">
          <select name="bankAccount" id="bankAccount"
                  ng-model="bankAccounts.selectedAccount"
                  ng-disabled="submitInProgress"
                  ng-options="account.BankAccountName for account in bankAccounts.getList()"
                  ng-class="{ 'nxg-invalid': validity.bankAccount.$error.required }"
                  nxg-track="{{metric.CLICK_CHECKOUT_SELECT_ACCOUNT}}"
                  required>
            <option value="">-- Select Bank --</option>
          </select>
        </div>
        <!-- We add an inline style (display: none) here to avoid the flash
        of our ng-show content before the page finishes compiling and knows
        the ng-show expression should evaluate to false. -->
        <label style="display:none" class="text-error" ng-show="validity.bankAccount.$error.required">Please select a bank account for payment.</label>


      </section>

    <button class="btn-cta cta-primary cta-full"
            ng-disabled="paymentQueue.contents.isEmpty() || submitInProgress"
            ng-click="submit()"
            nxg-track="{{metric.CLICK_CHECKOUT_SUBMIT_PAYMENTS_BUTTON}}">
      Submit Payments <span nxg-icon="icon-cart"></span>
    </button>
  </form>
</section>
